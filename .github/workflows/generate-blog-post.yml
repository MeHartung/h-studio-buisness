name: Generate Blog Post

on:
  workflow_dispatch:
    inputs:
      topic:
        description: 'Topic or theme for the blog post'
        required: true
        type: string
      title:
        description: 'Title of the blog post (optional, will be generated if not provided)'
        required: false
        type: string
      category:
        description: 'Category (e.g., –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è, –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏, –ö–µ–π—Å—ã)'
        required: false
        type: string
        default: '–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è'

jobs:
  generate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Generate blog post
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          TOPIC: ${{ github.event.inputs.topic }}
          TITLE: ${{ github.event.inputs.title }}
          CATEGORY: ${{ github.event.inputs.category }}
        run: |
          echo "Generating blog post for topic: $TOPIC"
          echo "Title: ${TITLE:-Auto-generated}"
          echo "Category: $CATEGORY"
          
          # Use AI generator if API key is available
          if [ -n "$OPENAI_API_KEY" ]; then
            echo "ü§ñ Using AI-powered content generation..."
            if [ -n "$TITLE" ]; then
              npm run blog:generate:ai -- --topic "$TOPIC" --title "$TITLE" --category "$CATEGORY"
            else
              npm run blog:generate:ai -- --topic "$TOPIC" --category "$CATEGORY"
            fi
          else
            echo "‚ö†Ô∏è  No OpenAI API key found, generating template..."
            echo "üí° To use AI generation, add OPENAI_API_KEY to GitHub Secrets"
            if [ -n "$TITLE" ]; then
              npm run blog:generate -- --topic "$TOPIC" --title "$TITLE" --category "$CATEGORY"
            else
              npm run blog:generate -- --topic "$TOPIC" --category "$CATEGORY"
            fi
          fi

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        id: cpr
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "Add blog post: ${{ github.event.inputs.title || github.event.inputs.topic }}"
          title: "Add blog post: ${{ github.event.inputs.title || github.event.inputs.topic }}"
          body: |
            This PR adds a new blog post generated from the topic: ${{ github.event.inputs.topic }}
            
            Category: ${{ github.event.inputs.category }}
          branch: blog-post/${{ github.run_number }}

      - name: Auto-merge Pull Request
        if: steps.cpr.outputs.pull-request-number != ''
        run: |
          gh pr merge ${{ steps.cpr.outputs.pull-request-number }} --merge
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

